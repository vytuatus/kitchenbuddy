<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Reset Password</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: sans-serif; max-width: 400px; margin: 5rem auto; padding: 1.5rem; border: 1px solid #ccc; border-radius: 8px; background: #fafafa; }
    h2 { text-align: center; }
    input { width: 100%; padding: 0.6rem; margin: 0.6rem 0; border: 1px solid #ccc; border-radius: 4px; }
    button { width: 100%; padding: 0.8rem; margin-top: 1rem; background: #28a745; border: none; border-radius: 4px; color: white; font-size: 1rem; cursor: pointer; }
    button:disabled { background: #aaa; cursor: not-allowed; }
    .message { margin-top: 1rem; text-align: center; font-size: 0.9rem; }
  </style>
</head>
<body>
  <h2>Reset your password</h2>
  <input type="password" id="new-password" placeholder="New password" />
  <input type="password" id="confirm-password" placeholder="Confirm password" />
  <button id="reset-btn">Update Password</button>
  <div class="message" id="message"></div>

  <script>
    const messageEl = document.getElementById("message");
    const resetBtn = document.getElementById("reset-btn");

    const params = new URLSearchParams(window.location.search);
    console.log(params);
    const token = params.get("token") || params.get("code");
    const email = params.get("email"); // Pass email in the recovery link

    if (!token || !email) {
      messageEl.textContent = "Invalid or missing recovery link.";
      resetBtn.disabled = true;
    }

    resetBtn.onclick = async () => {
      const password = document.getElementById("new-password").value;
      const confirm = document.getElementById("confirm-password").value;

      if (!password || password !== confirm) {
        messageEl.textContent = "Passwords do not match.";
        return;
      }

      resetBtn.disabled = true;
      messageEl.textContent = "Processing...";

      try {
        const res = await fetch("https://<project>.functions.supabase.co/reset-password", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ token, email, newPassword: password })
        });

        const data = await res.json();

        if (!res.ok) throw new Error(data?.error || "Failed to reset password");

        messageEl.textContent = "✅ Password reset successful!";
      } catch (err) {
        console.error(err);
        messageEl.textContent = "❌ " + err.message;
      } finally {
        resetBtn.disabled = false;
      }
    };
  </script>
</body>
</html>

